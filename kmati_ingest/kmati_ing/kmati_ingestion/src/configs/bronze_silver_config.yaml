execution:
  order:
    - bronze
    - silver

assets:

  bronze:
    # =====================================================
    # BRONZE – CUSTOMERS
    # =====================================================
    - name: bronze_customers
      asset_type: volume
      file_format: csv

      source_path: /Volumes/workspace/default/kmati_ingestion/customers
      target_table: workspace.default.bronze_customers

      write_mode: overwrite
      options:
        header: true
        infer_schema: false

      transformations:
        normalize_column_names: snake_case
        column_types:
          customer_id: string
          first_name: string
          last_name: string
          email_raw: string
          phone_raw: string
          birth_date_raw: string
          created_at_raw: string
        metadata:
          add_ingest_ts: true
          add_source_file: true
          add_batch_id: true


    # =====================================================
    # BRONZE – ACCOUNTS
    # =====================================================
    - name: bronze_accounts
      asset_type: volume
      file_format: csv

      source_path: /Volumes/workspace/default/kmati_ingestion/accounts
      target_table: workspace.default.bronze_accounts

      write_mode: overwrite
      options:
        header: true
        infer_schema: false

      transformations:
        normalize_column_names: snake_case
        column_types:
          account_id: string
          customer_id: string
          balance_raw: string
          currency_raw: string
          opened_date_raw: string
          status_raw: string
        metadata:
          add_ingest_ts: true
          add_source_file: true
          add_batch_id: true


    # =====================================================
    # BRONZE – TRANSACTIONS
    # =====================================================
    - name: bronze_transactions
      asset_type: volume
      file_format: csv

      source_path: /Volumes/workspace/default/kmati_ingestion/transactions
      target_table: workspace.default.bronze_transactions

      write_mode: overwrite
      options:
        header: true
        infer_schema: false

      transformations:
        normalize_column_names: snake_case
        column_types:
          txn_id: string
          account_id: string
          txn_timestamp_raw: string
          amount_raw: string
          txn_type_raw: string
          channel_raw: string
        metadata:
          add_ingest_ts: true
          add_source_file: true
          add_batch_id: true


    # =====================================================
    # BRONZE – MARKETING CALLS
    # =====================================================
    - name: bronze_marketing_calls
      asset_type: volume
      file_format: csv

      source_path: /Volumes/workspace/default/kmati_ingestion/marketing_calls
      target_table: workspace.default.bronze_marketing_calls

      write_mode: overwrite
      options:
        header: true
        infer_schema: false

      transformations:
        normalize_column_names: snake_case
        column_types:
          call_id: string
          customer_id: string
          age_raw: string
          job_raw: string
          marital_raw: string
          education_raw: string
          balance_raw: string
        metadata:
          add_ingest_ts: true
          add_source_file: true
          add_batch_id: true


  silver:
    # =====================================================
    # SILVER – CUSTOMERS
    # =====================================================
    - name: silver_customers
      asset_type: delta_table

      source_table: workspace.default.bronze_customers
      target_table: workspace.default.silver_customers

      write_mode: overwrite
      transformations:
        - { order: 0, trim_strings: { enabled: true, columns: [first_name, last_name, email_raw] } }
        - { order: 1, regex_clean: { enabled: true,
            email_columns: [{ name: email_raw, out: email, trim: true, lowercase: true }],
            number_columns: [] } }
        - { order: 2, null_handling: { enabled: true, drop_if_null: [customer_id] } }
        - { order: 3, duplicate_handling: { enabled: true, unique_keys: [customer_id] } }
        - { order: 4, standardize_column_case: { enabled: true, format: snake_case } }
        - { order: 5, surrogate_key: { enabled: true, column: customer_sk, method: uuid } }


    # =====================================================
    # SILVER – ACCOUNTS
    # =====================================================
    - name: silver_accounts
      asset_type: delta_table

      source_table: workspace.default.bronze_accounts
      target_table: workspace.default.silver_accounts

      write_mode: overwrite
      transformations:
        - { order: 0, trim_strings: { enabled: true,
            columns: [balance_raw, currency_raw, opened_date_raw, status_raw] } }
        - { order: 1, regex_clean: { enabled: true,
            number_columns:
              [{ name: balance_raw, out: balance_clean,
                 pattern_remove: "[^0-9\\.\\-]", trim: true }],
            email_columns: [] } }
        - { order: 2, parse_numeric: { enabled: true,
            columns: [{ name: balance_clean, out: balance, cast_type: double }] } }
        - { order: 3, parse_date: { enabled: true,
            columns: [{ name: opened_date_raw, out: opened_date,
              formats: ["yyyy-MM-dd", "dd/MM/yyyy"] }] } }
        - { order: 4, null_handling: { enabled: true,
            drop_if_null: [account_id, customer_id] } }
        - { order: 5, duplicate_handling: { enabled: true, unique_keys: [account_id] } }
        - { order: 6, surrogate_key: { enabled: true, column: account_sk, method: uuid } }
